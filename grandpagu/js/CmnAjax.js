"undefined" == typeof CmnMis && (CmnMis = {}); var CmnAjax = Cmn.Ajax = { Cfg: { ProxyUrl: "" }, MethodNameToUrl: function (a) { if (a.indexOf("/") > -1) return a; var b = window.location.href; return b.indexOf("?") > -1 && (b = b.substring(0, b.indexOf("?"))), b.indexOf("#") > -1 && (b = b.substring(0, b.indexOf("#"))), "/" == b[b.length - 1] ? b + a : b + "/" + a }, FillDataByClass: function (a, b, c, d, e, f) { return CmnAjax.FillData(a, b, c, d, e, f) }, FillData: function (a, b, c, d, e, f) { Cmn.FillData(a, []), CmnAjax.ShowAjaxHandleHint(f, a), CmnAjax.PostData(b, c, function (b) { return CmnAjax.HideAjaxHandleHint(f), Cmn.FillData(a, b.data), d && d(b), !0 }, function () { return CmnAjax.HideAjaxHandleHint(f), e && e(), !1 }) }, DataPagingList: new Array, DataPaging: function (dataContainerSelector, methodName, param, pageContainerSelector, pageSize, successFunc, errorFunc, loadingSelector, curPageNo) { function PagingFunction(pageNo) { eval("if(" + _dataPagingVarName + ".EventBeforePaging!=null) { " + _dataPagingVarName + ".EventBeforePaging(); }"), methodName = Cmn.Func.AddParamToUrl(methodName, "CurPage=" + pageNo), methodName = Cmn.Func.AddParamToUrl(methodName, "PageSize=" + pageSize), CmnAjax.ShowAjaxHandleHint(loadingSelector, dataContainerSelector), CmnAjax.PostData(methodName, param, function (a) { return CmnAjax.HideAjaxHandleHint(loadingSelector), Cmn.FillData(dataContainerSelector, a.data), successFunc && successFunc(a), !0 }, function (a) { return CmnAjax.HideAjaxHandleHint(loadingSelector), errorFunc && errorFunc(a), Cmn.Log("DataPaging填充数据时Ajax报错！dataContainerSelector:" + dataContainerSelector + " methodName:" + methodName + " param:" + param + " 错误详细信息：" + a.responseText), !1 }) } this.EventBeforePaging = null, Cmn.FillData(dataContainerSelector, []), curPageNo || (curPageNo = 1), methodName = CmnAjax.MethodNameToUrl(methodName), CmnAjax.DataPagingList[CmnAjax.DataPagingList.length] = this; var _dataPagingVarName = "CmnAjax.DataPagingList[" + (CmnAjax.DataPagingList.length - 1) + "]"; this.Paging = new Cmn.Paging(pageContainerSelector, 0, pageSize, PagingFunction), this.Refresh = function (paging) { methodName = Cmn.Func.AddParamToUrl(methodName, "CurPage=" + curPageNo), methodName = Cmn.Func.AddParamToUrl(methodName, "PageSize=" + pageSize), CmnAjax.ShowAjaxHandleHint(loadingSelector, dataContainerSelector), CmnAjax.PostData(methodName, param, function (data) { return CmnAjax.HideAjaxHandleHint(loadingSelector), eval(_dataPagingVarName + ".Paging.RecCount=" + data.RecCount + ";"), eval(_dataPagingVarName + ".Paging.ToPage(" + curPageNo + ",false);"), Cmn.FillData(dataContainerSelector, data.data), successFunc && successFunc(data), !0 }, function (a) { return CmnAjax.HideAjaxHandleHint(loadingSelector), errorFunc && errorFunc(a), Cmn.Log("DataPaging填充数据时Ajax报错！dataContainerSelector:" + dataContainerSelector + " methodName:" + methodName + " param:" + param + "  错误详细信息：" + a.responseText), !1 }) }, this.Refresh(this.Paging) }, PicStepLoadList: new Array, DataStepLoad: function (dataContainerSelector, methodName, param, pageContainerSelector, pageSize, blockSize, successFunc, errorFunc, loadingSelector) { function PagingFunction(pageNo) { eval(_picStepLoadListVarName + ".CurrBlockNo=" + (pageNo - 1) * pageSize / blockSize + ";" + _picStepLoadListVarName + ".IsNewPage=true;" + _picStepLoadListVarName + ".IsAddingBlock=false;" + _picStepLoadListVarName + ".AddBlock();") } var _picStepLoadListVarName, _dataContainerSelectorOne, _scrollHeight, _sensitivity, _$scrollContainer, _self; return this.CurrBlockNo = 0, this.IsNewPage = !0, this.IsAddingBlock = !1, this.RecCount = 100, this.Destroyed = !1, this.ScrollContainerSelector = "", this.LoadingSensitivity = 50, Cmn.FillData(dataContainerSelector, []), methodName = CmnAjax.MethodNameToUrl(methodName), CmnAjax.PicStepLoadList[CmnAjax.PicStepLoadList.length] = this, _picStepLoadListVarName = "CmnAjax.PicStepLoadList[" + (CmnAjax.PicStepLoadList.length - 1) + "]", _dataContainerSelectorOne = dataContainerSelector, Cmn.Func.IsArray(dataContainerSelector) && (_dataContainerSelectorOne = dataContainerSelector[0]), this.AddBlock = function () { if (1 == this.Destroyed) return console.log("已经删除(刚进入AddBlock)"), !0; if (!this.IsAddingBlock) { if (this.IsAddingBlock = !0, 0 != this.CurrBlockNo && 0 == this.CurrBlockNo % (pageSize / blockSize) && 0 == this.IsNewPage) return this.IsAddingBlock = !1, void 0; if (this.CurrBlockNo >= parseInt((this.RecCount + blockSize - 1) / blockSize)) return this.IsAddingBlock = !1, void 0; methodName = Cmn.Func.AddParamToUrl(methodName, "CurPage=" + (this.CurrBlockNo + 1)), methodName = Cmn.Func.AddParamToUrl(methodName, "PageSize=" + blockSize); var _isNewPage = this.IsNewPage; CmnAjax.ShowAjaxHandleHint(loadingSelector, _dataContainerSelectorOne), CmnAjax.PostData(methodName, param, function (data) { return CmnAjax.HideAjaxHandleHint(loadingSelector), 1 == eval("(" + _picStepLoadListVarName + ".Destroyed)") ? (console.log("已经删除"), !0) : (Cmn.FillData(dataContainerSelector, data.data, _isNewPage ? !1 : !0, !0), successFunc && successFunc(data), eval(_picStepLoadListVarName + ".CurrBlockNo++;" + _picStepLoadListVarName + ".IsNewPage=false;" + _picStepLoadListVarName + ".IsAddingBlock=false;" + _picStepLoadListVarName + ".RecCount=" + data.RecCount + ";"), !0) }, function (a) { return CmnAjax.HideAjaxHandleHint(loadingSelector), errorFunc && errorFunc(a), Cmn.Log("PicStepLoad填充数据时Ajax报错！dataContainerSelector:" + dataContainerSelector + " methodName:" + methodName + " param:" + param + " 错误详细信息：" + a.responseText), !1 }) } }, _scrollHeight = 0, _sensitivity = this.LoadingSensitivity, _$scrollContainer = $(window), _self = this, this.BindScrollLoadData = function () { _scrollHeight = 0, _sensitivity = this.LoadingSensitivity, _$scrollContainer = $(window), "" != this.ScrollContainerSelector ? (_$scrollContainer = $(this.ScrollContainerSelector), _scrollHeight = _$scrollContainer[0].scrollHeight) : _scrollHeight = document.body.scrollHeight || document.documentElement.scrollHeight, _$scrollContainer.off("scroll").on("scroll", function () { 0 == _scrollHeight && (_scrollHeight = "" != _self.ScrollContainerSelector ? _$scrollContainer[0].scrollHeight : document.body.scrollHeight || document.documentElement.scrollHeight), _$scrollContainer.scrollTop() + _$scrollContainer.height() + _sensitivity >= _scrollHeight && eval(_picStepLoadListVarName + ".AddBlock();") }) }, this.Destroy = function () { if (Cmn.Func.IsArray(dataContainerSelector)) for (var a = 0; a < dataContainerSelector.length; a++) $(dataContainerSelector[a]).siblings().html(""); else $(dataContainerSelector).siblings().html(""); $(window).off("scroll", ScrollHandle), this.Destroyed = !0 }, null == pageContainerSelector || "undefind" == typeof pageContainerSelector || "" == pageContainerSelector ? (this.AddBlock(), void 0) : (this.Paging = new Cmn.Paging(pageContainerSelector, 0, pageSize, PagingFunction), this.Refresh = function () { eval(_picStepLoadListVarName + ".AddBlock();"), methodName = Cmn.Func.AddParamToUrl(methodName, "CurPage=1"), methodName = Cmn.Func.AddParamToUrl(methodName, "PageSize=" + pageSize), CmnAjax.PostData(methodName, param, function (data) { return eval(_picStepLoadListVarName + ".Paging.RecCount=" + data.RecCount + ";"), eval(_picStepLoadListVarName + ".Paging.ToPage(1,false);"), !0 }, function (a) { return errorFunc && errorFunc(a), Cmn.Log("picStepLoad填充数据时Ajax报错！dataContainerSelector:" + dataContainerSelector + " methodName:" + methodName + " param:" + param + "  错误详细信息：" + a.responseText), !1 }) }, this.Refresh(), void 0) }, SubmitData: function (containerSelector, methodName, param, checkRegular, errDispSelector, submitingHintSelector, successFunc, errorFunc) { var _i, _tmpDom, _tmpValue, _retText, _isWebMethod, _execComplete, _tmpData, _data = "", _errMsg = "", _radioLst = new Array; if (methodName = CmnAjax.MethodNameToUrl(methodName), $(containerSelector).find("input[id][type!='button'][id!='__VIEWSTATE']").add(containerSelector + " textarea").add(containerSelector + " select").each(function () { var b, c, d, e, a = $(this).attr("id").toString(); if (null != a && void 0 != a && a.length > 3) { if (a = a.substring(3), "checkbox" == $(this).attr("type")) _value = $(this).attr("checked") ? "1" : "0"; else { if ("radio" == $(this).attr("type")) { if (b = !1, c = $(this).attr("name"), c.length <= 3) return; for (d = 0; d < _radioLst.length; d++) if (_radioLst[d] == c) { b = !0; break } return b || _radioLst.push(c), void 0 } _value = $(this).val() } if (null != checkRegular && void 0 != checkRegular && null != checkRegular[a] && void 0 != checkRegular[a] && (e = Cmn.CheckValid(checkRegular[a], _value), 1 != e)) return _errMsg += e, !1; _data.length > 1 && (_data += ","), _data += "'" + a + "':'" + Cmn.Func.FormatJsonData(_value) + "'" } }), "" != _errMsg) return errDispSelector ? $(errDispSelector).html(_errMsg) : alert(_errMsg), !1; for (errDispSelector && $(errDispSelector).html(""), _i = 0; _i < _radioLst.length; _i++) _tmpDom = $("input[name='" + _radioLst[_i] + "']:checked"), _tmpValue = "", _tmpDom.length > 0 && (_tmpValue = _tmpDom.val()), _data.length > 1 && (_data += ","), _data += "'" + _radioLst[_i].substring(3) + "':'" + _tmpValue + "'"; if ("" == _data) return !1; if (Cmn.Func.IsString(param) || (param = Cmn.Func.JsonToStr(param)), param && "" != param && (param = Cmn.Func.Trim(param), param = param.substring(1), param = param.substring(0, param.length - 1), "" != param && (_data = _data + "," + param)), _retText = "", methodName = CmnAjax.Func.GetProxyUrl(methodName), _isWebMethod = Cmn.Func.IsWebMethod(methodName), _execComplete = !1, _tmpData = "{" + _data + "}", !_isWebMethod) try { _tmpData = eval("({" + _data + "})") } catch (err) { Cmn.alert("输入的内容可能存在问题！错误信息：" + err.message) } return CmnAjax.ShowAjaxHandleHint(submitingHintSelector), _retText = CmnAjax.GetData(methodName, _tmpData, submitingHintSelector, successFunc, errorFunc) }, GetData: function (methodName, param, getingHintSelector, successFunc, errorFunc) { var _isWebMethod, _retText, _hasExecComplete, _paramJson, _dataType; return methodName = CmnAjax.MethodNameToUrl(methodName), methodName = CmnAjax.Func.GetProxyUrl(methodName), _isWebMethod = Cmn.Func.IsWebMethod(methodName), _retText = "", _hasExecComplete = !1, _paramJson = null, void 0 != param && (Cmn.Func.IsString(param) ? ("" == param && (param = "{}"), 0 == _isWebMethod ? (param = eval("(" + param + ")"), _paramJson = param) : _paramJson = eval("(" + param + ")")) : (_paramJson = param, _isWebMethod && (param = Cmn.Func.JsonToStr(param)))), CmnAjax.ShowAjaxHandleHint(getingHintSelector), _dataType = "text", $.ajax({ type: "Post", url: methodName, dataType: _dataType, jsonp: "callback", contentType: _isWebMethod ? "application/json;charset=uft-8" : "application/x-www-form-urlencoded", data: param, async: !1, success: function (retData) { if (CmnAjax.HideAjaxHandleHint(getingHintSelector), _isWebMethod) if (_retText = eval("(" + retData + ")").d, null == _retText) _retText = ""; else try { _retText = eval("(" + _retText + ")") } catch (er) { } else try { _retText = eval("(" + retData + ")") } catch (err) { _retText = retData } successFunc && successFunc(_retText), _hasExecComplete = !0 }, error: function (a) { _hasExecComplete = !0, CmnAjax.HideAjaxHandleHint(getingHintSelector), Cmn.Log("GetData！ methodName:" + methodName + " param:" + Cmn.Func.JsonToStr(param) + "  错误详细信息：" + a.responseText), errorFunc && errorFunc(a) } }), _retText }, PostData: function (methodName, param, successFunc, errorFunc) { var _isWebMethod, _paramJson, _dataType; methodName = CmnAjax.MethodNameToUrl(methodName), methodName = CmnAjax.Func.GetProxyUrl(methodName), _isWebMethod = Cmn.Func.IsWebMethod(methodName), _paramJson = null, void 0 != param && (Cmn.Func.IsString(param) ? ("" == param && (param = "{}"), 0 == _isWebMethod ? (param = eval("(" + param + ")"), _paramJson = param) : _paramJson = eval("(" + param + ")")) : (_paramJson = param, _isWebMethod && (param = Cmn.Func.JsonToStr(param)))), CmnAjax.ShowAjaxHandleHint(""), _dataType = "text", Cmn.Func.IsSameMainDomain(methodName) === !1 && (_dataType = "jsonp"), $.ajax({ type: "Post", jsonp: "callback", url: methodName, data: param, contentType: _isWebMethod ? "application/json;charset=uft-8" : "application/x-www-form-urlencoded", dataType: _dataType, success: function (retData) { CmnAjax.HideAjaxHandleHint(""); var _retVal = ""; if (_isWebMethod) if (_retVal = eval("(" + retData + ")").d, null == _retVal) _retVal = ""; else try { _retVal = eval("(" + _retVal + ")") } catch (er) { } else try { _retVal = eval("(" + retData + ")") } catch (err) { _retVal = retData } return successFunc && successFunc(_retVal), !0 }, error: function (a) { return CmnAjax.HideAjaxHandleHint(""), errorFunc && errorFunc(a), Cmn.Log("PostData填充数据时Ajax报错！ methodName:" + methodName + " param:" + Cmn.Func.JsonToStr(param) + "  错误详细信息：" + a.responseText), !1 } }) }, GetFile: function (a, b, c, d) { var g, h, e = "", f = "text"; return "" == a ? "" : (g = a.lastIndexOf("."), -1 != g && (f = Cmn.Func.Trim(a.substring(g + 1)), f = "js" == f ? "script" : "htm" == f ? "html" : "text"), h = !1, d === !1 && (h = !0), CmnAjax.ShowAjaxHandleHint(""), $.ajax({ type: "GET", url: a, async: h, dataType: f, success: function (a) { CmnAjax.HideAjaxHandleHint(""), e = a, b && b(e) }, error: function (b, d) { CmnAjax.HideAjaxHandleHint(""), c && c(), Cmn.Log("GetFile！ fileUrl:" + a + "； dataType:" + f + "；  错误详细信息：" + d + "------" + b.responseText) } }), e) }, GetField: function (fieldName, tableName, condition, orderBy) { var _retText, _retVal; return condition = condition ? condition.replace(new RegExp("'", "g"), "\\'") : "", orderBy = orderBy ? orderBy.replace(new RegExp("'", "g"), "\\'") : "", _retText = "", _retVal = $.ajax({ type: "Post", url: "/CmnAjax/CmnAjax.aspx/GetField", dataType: "text", contentType: "application/json;charset=uft-8", async: !1, data: "{fieldName:'" + fieldName + "',tableName:'" + tableName + "',condition:'" + condition + "',orderBy:'" + orderBy + "'}", success: function (retData) { try { _retText = eval("(" + retData + ")").d, _retText || (_retText = retData) } catch (err) { _retText = retData } }, error: function (a) { Cmn.Log("GetField ajax调用错误！ fieldName:" + fieldName + "  tableName：" + tableName + "  错误明细：" + a.responseText) } }), _retText }, ShowDefaultAjaxHintCount: 0, ShowAjaxHandleHint: function (a, b) { null != a && "" != a && "undefind" != typeof a ? (null != b && "" != b && "undefind" != typeof b && (Cmn.Func.IsArray(b) && (b = b[0]), $(a).parent().children(b).length > 0 && $(a).parent().each(function () { $(this).append($(this).children(a)) })), $(a).show()) : (0 == CmnAjax.ShowDefaultAjaxHintCount && $("body").append("<div class='body_loading' style='position:fixed;right:4px;bottom:4px;font-size:12px;z-index:10001;color:#ffffff;padding:2px;padding-left:6px;padding-right:6px; background:rgba(33, 33, 33, 0.4) none repeat scroll 0 0 !important;filter:Alpha(opacity=40);background:#333333;'> <span style='position:relative;'> Loading... </span></div>"), CmnAjax.ShowDefaultAjaxHintCount++) }, HideAjaxHandleHint: function (a) { null != a && "" != a && "undefind" != typeof a ? $(a).hide() : (CmnAjax.ShowDefaultAjaxHintCount--, 0 == CmnAjax.ShowDefaultAjaxHintCount && $("body .body_loading").remove()) }, Func: { GetProxyUrl: function (a) { return "" == CmnAjax.Cfg.ProxyUrl ? a : a.indexOf("?TargetUrl=") >= 0 ? a : CmnAjax.Cfg.ProxyUrl + "?TargetUrl=" + encodeURIComponent(a) }, HasLoadJsUrl: {}, HasLoadCss: {}, LoadJs: function (a, b, c) { if ("undefined" == typeof c && (c = !1), 0 != c) return CmnAjax.GetFile(a, b, b); var d = CmnAjax.Func.HasLoadJsUrl[a]; return null == d || void 0 == d ? (CmnAjax.Func.HasLoadJsUrl[a] = a, CmnAjax.GetFile(a, b, b)) : void 0 }, LoadCss: function (a) { var b, c, d; if (!a || 0 === a.length) throw new Error('argument "path" is required !'); b = CmnAjax.Func.HasLoadCss[a], b || (c = document.getElementsByTagName("head")[0], d = document.createElement("link"), d.href = a, d.rel = "stylesheet", d.type = "text/css", c.appendChild(d), CmnAjax.Func.HasLoadCss[a] = a) } } };